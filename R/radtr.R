#' Tumor Response Analysis Dataset (ADTR)
#'
#' Function for generating random dataset from Tumor Response Analysis Dataset for a given
#' Subject-Level Analysis Dataset.
#'
#' @details One record per subject per parameter per analysis visit per analysis date.
#'
#' Keys: STUDYID, USUBJID, PARAMCD, BASETYPE, AVISITN, DTYPE
#'
#' @template ADSL_params
#' @param param As character string. list of parameter values.
#' @param paramcd As character string. list of parameter code values.
#' @param ... parameters from \code{\link{radrs}}
#'
#' @templateVar data adtr
#' @template param_cached
#' @template return_data.frame
#'
#' @importFrom dplyr arrange case_when group_by mutate n rowwise select ungroup slice
#' @importFrom magrittr %>%
#' @importFrom stats rnorm
#'
#' @export
#'
#' @author tomlinsj, npaszty, Xuefeng Hou, dipietrc
#'
#' @examples
#' library(random.cdisc.data)
#' ADSL <- radsl(N = 10, seed = 1, study_duration = 2)
#' radtr(ADSL, seed = 2)
radtr <- function(ADSL, # nolint
                  param = c("Sum of Longest Diameter by Investigator"),
                  paramcd = c("SLDINV"),
                  seed = NULL,
                  cached = FALSE,
                  ...) {
  stopifnot(is_logical_single(cached))
  if (cached) {
    return(get_cached_data("cadtr"))
  }
  stopifnot(is.data.frame(ADSL))
  stopifnot(is_character_vector(param))
  stopifnot(is_character_vector(paramcd))
  stopifnot(is.null(seed) || is_numeric_single(seed))
  stopifnot(length(param) == length(paramcd))
  # validate and initialize related variables

  if (!is.null(seed)) {
    set.seed(seed)
  }

  # Make times consistent with ADRS at ADY and ADTM.
  adrs <- radrs(ADSL, seed = seed, ...) %>% # nolint
    dplyr::filter(.data$PARAMCD == "OVRINV") %>% # nolint
    dplyr::select(.data$STUDYID, .data$USUBJID, .data$AVISIT, .data$AVISITN, .data$ADTM, .data$ADY)

  ADTR <- Map(function(parcd, par) {
    df <- adrs
    df$AVAL <- rnorm(nrow(df), mean = 150, sd = 30)
    df$PARAMCD <- parcd
    df$PARAM <- par
    df
  }, paramcd, param) %>%
    Reduce(rbind, .)

  ADTR_base <- ADTR %>%
    dplyr::filter(.data$AVISITN == 0) %>%
    dplyr::group_by(.data$USUBJID, .data$PARAMCD) %>%
    dplyr::mutate(BASE = .data$AVAL) %>%
    dplyr::select(.data$STUDYID, .data$USUBJID, .data$BASE, .data$PARAMCD)

  ADTR_postbase <- ADTR %>%
    dplyr::filter(.data$AVISITN > 0) %>%
    dplyr::filter(!is.na(.data$AVAL)) %>%
    dplyr::group_by(.data$USUBJID, .data$PARAMCD) %>%
    dplyr::filter(.data$AVAL == min(.data$AVAL)) %>%
    slice(1) %>%
    mutate(AVISIT = "POST-BASELINE MINIMUM") %>%
    mutate(DTYPE = "MINIMUM") %>%
    ungroup()

  ADTR_lastobs <- ADTR %>%
    dplyr::filter(.data$AVISITN > 0) %>%
    dplyr::filter(!is.na(.data$AVAL)) %>%
    dplyr::group_by(.data$USUBJID, .data$PARAMCD) %>%
    dplyr::filter(.data$ADTM == max(.data$ADTM, na.rm = TRUE)) %>%
    slice(1) %>%
    dplyr::mutate(LAST_VISIT = .data$AVISIT) %>%
    ungroup() %>%
    dplyr::select(.data$STUDYID, .data$USUBJID, .data$PARAMCD, .data$LAST_VISIT)

  ADTR <- rbind(ADTR %>% dplyr::mutate(DTYPE = ""), ADTR_postbase)

  ADTR <- merge(ADTR, ADTR_base, by = c("STUDYID", "USUBJID", "PARAMCD")) %>%
    dplyr::mutate(
      ABLFL = case_when(.data$AVISIT == "BASELINE" ~ "Y",
                        TRUE ~ ""),
      AVAL = case_when(.data$AVISIT == "BASELINE" ~ NA_real_,
                       TRUE ~ AVAL),
      CHG = case_when(.data$AVISITN > 0 ~ .data$AVAL - .data$BASE,
                      TRUE ~ NA_real_),

      PCHG = case_when(.data$AVISITN > 0 ~ .data$CHG / .data$BASE * 100,
                       TRUE ~ NA_real_),
      AVALC = as.character(.data$AVAL),
      AVALU = "mm"
    )

  # ensure PCHG does not exceed 200%, nor go below -100% (double in size, or complete remission of tumor).
  ADTR <- ADTR %>%
    dplyr::mutate(
      PCHG_DUM = .data$PCHG,
      PCHG = case_when(
        .data$PCHG_DUM > 200 ~ 200,
        .data$PCHG_DUM < -100 ~ -100,
        TRUE ~ .data$PCHG
      ),
      AVAL = case_when(
        .data$PCHG_DUM > 200 ~ 3 * .data$BASE,
        .data$PCHG_DUM < -100 ~ 0,
        TRUE ~ .data$AVAL
      ),
      CHG = case_when(
        .data$PCHG_DUM > 200 ~ 2 * .data$BASE,
        .data$PCHG_DUM < -100 ~ -.data$BASE,
        TRUE ~ .data$CHG
      )
    ) %>%
    dplyr::select(-.data$PCHG_DUM)

  ADTR <- merge(ADSL, ADTR, by = c("STUDYID", "USUBJID")) %>%
    dplyr::group_by(.data$USUBJID, .data$PARAMCD) %>%
    dplyr::mutate(
      ONTRTFL = case_when(
        is.na(.data$TRTSDTM) ~ "",
        is.na(.data$ADTM) ~ "Y",
        .data$ADTM < .data$TRTSDTM ~ "",
        TRUE ~ "Y"
      ),
      ANL01FL = case_when(
        .data$DTYPE == "" & .data$AVISITN > 0 ~ "Y",
        TRUE ~ ""
      ),
      ANL03FL = case_when(
        .data$DTYPE == "MINIMUM" ~ "Y",
        .data$ABLFL == "Y" ~ "Y",
        TRUE ~ ""
      )
    )
  ADTR <- merge(ADTR, ADTR_lastobs, by = c("STUDYID", "USUBJID", "PARAMCD")) %>%
    dplyr::mutate(
      ANL02FL = case_when(
        as.character(.data$AVISIT) == as.character(.data$LAST_VISIT) ~ "Y",
        .data$ABLFL == "Y" ~ "Y",
        TRUE ~ ""
      )
    ) %>%
    dplyr::select(-.data$LAST_VISIT)
  # Adding variables that are in ADTR osprey but not RCD.
  ADTR <- ADTR %>% # nolint
    dplyr::mutate(
      AEWITHFL = ifelse(.data$DCSREAS == "ADVERSE EVENT", "Y", "N"),
      DTHFL = ifelse(!is.na(.data$DTHDT), "Y", ""),
      DCSREAS_GRP = ifelse(.data$DCSREAS == "ADVERSE EVENT", "Safety", "Non-Safety"),
      TRTDURD = ifelse(is.na(.data$TRTSDTM) | is.na(.data$TRTEDTM), NA, .data$TRTEDTM - (.data$TRTSDTM + 1)),
      AGEGR1 = ifelse(.data$AGE < 65, "<65", ">=65")
    )

  # apply metadata
  ADTR <- apply_metadata(ADTR, "metadata/ADTR.yml") # nolint
  return(ADTR)

}
